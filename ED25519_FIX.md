# Ed25519 Signature Error - Fixed

## Problem

When using Ed25519 signatures, the TAP Agent failed with:
```
‚ùå Error creating Ed25519 signature: An Ed25519 private key is 32 bytes long
```

## Root Cause

The `agent_app.py` code expected Ed25519 keys in a specific format:
- **Expected**: Base64-encoded raw 32-byte keys
- **Generated**: PEM-formatted keys (with headers like `-----BEGIN PRIVATE KEY-----`)

The code at line 1353 tried to decode the key as base64:
```python
private_bytes = base64.b64decode(ed25519_private_b64)
private_key = ed25519.Ed25519PrivateKey.from_private_bytes(private_bytes)
```

But PEM format includes headers and structure, not just raw bytes, causing the decode to fail.

## Solution

Updated `generate_keys.py` to generate Ed25519 keys in the correct format:

### Before (PEM format):
```python
private_pem = private_key.private_bytes(
    encoding=serialization.Encoding.PEM,
    format=serialization.PrivateFormat.PKCS8,
    encryption_algorithm=serialization.NoEncryption()
).decode('utf-8')
```

### After (Raw bytes, base64-encoded):
```python
private_bytes = private_key.private_bytes(
    encoding=serialization.Encoding.Raw,
    format=serialization.PrivateFormat.Raw,
    encryption_algorithm=serialization.NoEncryption()
)
private_b64 = base64.b64encode(private_bytes).decode('utf-8')
```

## Key Format Differences

### RSA Keys (PEM format with escaped newlines):
```bash
RSA_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgk...\n-----END PRIVATE KEY-----\n"
```

### Ed25519 Keys (Base64-encoded raw 32 bytes):
```bash
ED25519_PRIVATE_KEY="2lka6DSiscm9utqkccU615oez3bV2QuJ6C8S3o/T1OY="
ED25519_PUBLIC_KEY="A0LEzedOrxk15qZJnGtIWL73f85JbpN4Fw8ApyxYm00="
```

## Verification

After regenerating keys, verify they work:

```bash
cd tap-agent
~/.pyenv/versions/3.13.0/bin/python3 -c "
from dotenv import load_dotenv
import os
import base64
from cryptography.hazmat.primitives.asymmetric import ed25519

load_dotenv()
ed_priv = os.getenv('ED25519_PRIVATE_KEY')
private_bytes = base64.b64decode(ed_priv)
print(f'Private key length: {len(private_bytes)} bytes')
private_key = ed25519.Ed25519PrivateKey.from_private_bytes(private_bytes)
print('‚úÖ Ed25519 key loaded successfully!')
"
```

Expected output:
```
Private key length: 32 bytes
‚úÖ Ed25519 key loaded successfully!
```

## Files Modified

1. **`generate_keys.py`**
   - Changed Ed25519 key generation to use `Raw` encoding
   - Output base64-encoded 32-byte keys instead of PEM
   - Updated display to show full Ed25519 keys (they're short)

2. **`.env.example`**
   - Updated documentation to show correct key formats
   - Added comments explaining the difference between RSA and Ed25519 formats

3. **`.gitignore`**
   - Added `*.pem` to ignore manually generated key files

## How to Regenerate Keys

If you need to regenerate keys with the correct format:

```bash
cd tap-agent
~/.pyenv/versions/3.13.0/bin/python3 generate_keys.py
```

This will:
- ‚úÖ Generate RSA keys in PEM format (with escaped newlines)
- ‚úÖ Generate Ed25519 keys in base64 raw format (32 bytes each)
- ‚úÖ Create/overwrite `.env` file with correct format
- ‚úÖ Display all keys for verification

## Testing Ed25519 Signatures

After regenerating keys, test the Ed25519 signature:

1. Start the TAP Agent:
   ```bash
   cd tap-agent
   streamlit run agent_app.py
   ```

2. In the UI:
   - Select **"ed25519"** as the signature algorithm
   - Enter a merchant URL (e.g., `http://localhost:3001/product/1`)
   - Click "Generate Signature & Launch Browser"

3. Expected output:
   ```
   üîê Creating Ed25519 signature...
   üåê Authority: localhost:3001
   üìç Path: /product/1
   üîê Ed25519 Signature Base String:
   "@authority": localhost:3001
   "@path": /product/1
   "@signature-params": ...
   üîë Using Ed25519 keys from environment variables
   ‚úÖ Created Ed25519 signature
   üì§ Signature-Input: sig2=...
   üîí Signature: sig2=:...
   ```

## Why Two Key Formats?

The protocol supports multiple signing algorithms:

- **RSA-PSS-SHA256**: Industry standard, widely supported
  - Uses PEM format (standard for RSA keys)
  - Larger keys (2048 bits = 256 bytes)
  
- **Ed25519**: Modern elliptic curve algorithm
  - Uses raw bytes (standard for Ed25519)
  - Smaller keys (256 bits = 32 bytes)
  - Faster signing and verification

Each algorithm has its own standard format, which is why they're stored differently.

## Status

‚úÖ **Fixed**: Ed25519 keys now generate in the correct format
‚úÖ **Verified**: Keys load successfully and create valid signatures
‚úÖ **Documented**: Updated .env.example with correct format examples

The TAP Agent can now use both RSA and Ed25519 signatures successfully!
